name: Release Published

on:
  release:
    types: [published]

jobs:
  trigger-packaging:
    runs-on: ubuntu-latest
    steps:
    - name: Determine channel
      id: channel
      run: |
        # Pre-releases go to unstable, regular releases go to stable
        if [ "${{ github.event.release.prerelease }}" = "true" ]; then
          echo "channel=unstable" >> $GITHUB_OUTPUT
          echo "Detected pre-release: sending to unstable channel"
        else
          echo "channel=stable" >> $GITHUB_OUTPUT
          echo "Detected regular release: sending to stable channel"
        fi

    - name: Trigger APT repository
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.REPO_DISPATCH_PAT }}
        repository: hatlabs/apt.hatlabs.fi
        event-type: package-updated
        client-payload: |
          {
            "repository": "${{ github.repository }}",
            "distro": "any",
            "channel": "${{ steps.channel.outputs.channel }}",
            "component": "main"
          }
