name: Auto Pre-release

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering for testing

permissions:
  contents: write

jobs:
  auto-prerelease:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Read version from debian/changelog
      id: version
      run: .github/scripts/read-version.sh

    - name: Check if published release exists
      id: check
      run: .github/scripts/check-release-exists.sh "${{ steps.version.outputs.version }}" prerelease
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Setup Node.js
      if: steps.check.outputs.action == 'create'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    - name: Install build dependencies
      if: steps.check.outputs.action == 'create'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          build-essential \
          dpkg-dev \
          debhelper \
          dh-python \
          python3-all \
          python3-apt \
          python3-hatchling \
          nodejs \
          npm

    - name: Build frontend
      if: steps.check.outputs.action == 'create'
      run: .github/scripts/build-frontend.sh

    - name: Build .deb package
      if: steps.check.outputs.action == 'create'
      run: .github/scripts/build-deb-package.sh

    - name: Generate release notes
      if: steps.check.outputs.action == 'create'
      id: notes
      run: .github/scripts/generate-release-notes.sh "${{ steps.version.outputs.version }}" "${{ steps.version.outputs.tag_version }}" prerelease
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Delete existing pre-release
      if: steps.check.outputs.action == 'create'
      run: |
        TAG_VERSION="${{ steps.version.outputs.tag_version }}"
        if gh release view "v${TAG_VERSION}" &>/dev/null; then
          IS_PRERELEASE=$(gh release view "v${TAG_VERSION}" --json isPrerelease --jq '.isPrerelease')
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "üóëÔ∏è  Deleting existing pre-release v${TAG_VERSION}"
            gh release delete "v${TAG_VERSION}" --yes --cleanup-tag
          fi
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Create pre-release
      if: steps.check.outputs.action == 'create'
      run: |
        TAG_VERSION="${{ steps.version.outputs.tag_version }}"
        if ! ls ../*.deb 1> /dev/null 2>&1; then
          echo "‚ùå Error: No .deb files found"
          exit 1
        fi
        echo "üì¶ Creating pre-release v${TAG_VERSION}"
        gh release create "v${TAG_VERSION}" \
          --prerelease \
          --title "v${TAG_VERSION} (Pre-release)" \
          --notes-file release_notes.md \
          ../*.deb
        echo "‚úÖ Pre-release created successfully"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Dispatch to APT repository
      if: steps.check.outputs.action == 'create'
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.REPO_DISPATCH_PAT }}
        repository: hatlabs/apt.hatlabs.fi
        event-type: package-updated
        client-payload: |
          {
            "repository": "${{ github.repository }}",
            "distro": "trixie",
            "channel": "unstable",
            "component": "main"
          }

    - name: Report success
      if: steps.check.outputs.action == 'create'
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        TAG_VERSION="${{ steps.version.outputs.tag_version }}"
        echo "=== Auto Pre-release Complete ==="
        echo "Package version: ${VERSION}"
        echo "Release tag: v${TAG_VERSION}"
        echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/v${TAG_VERSION}"
        echo ""
        echo "‚úÖ Dispatched to apt.hatlabs.fi unstable channel"
