#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands for cockpit-apt development.
#

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Store the absolute path to this script (useful for recursion).
readonly SCRIPT="$PROJECT_ROOT/$(basename "$0")"

################################################################################
# Helper Functions

function devtools {
  #@ Run command in devtools container
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools "$@"
}

function debtools {
  #@ Run command in debtools container (Debian packaging)
  docker compose -f docker/docker-compose.debtools.yml run --rm debtools "$@"
}

################################################################################
# Debian Package Building Commands

function build-deb {
  #@ Build Debian package in debtools container
  #@ Category: Debian
  echo "ðŸ“¦ Building Debian package..."
  # Build in debtools container which has all build dependencies pre-installed
  # dpkg-buildpackage writes to .. by convention, so we move files back after
  debtools \
    bash -c "dpkg-buildpackage -b -uc -us && mv ../*.deb ../*.buildinfo ../*.changes ./ 2>/dev/null || true"

  # List generated packages
  echo "ðŸ“¦ Generated packages:"
  ls -lh cockpit-apt*.deb 2>/dev/null || echo "âš ï¸  No .deb files found"
  echo "âœ… Package build complete"
}

################################################################################
# Backend proxy

function backend {
  #@ Proxy to backend run script
  #@ Category: Backend
  echo "âž¡ï¸  Running backend command in ./backend/run"
  cd backend
  ./run "$@"
}

function test {
  #@ Run backend tests (proxy)
  #@ Category: Backend
  backend test "$@"
}

function lint {
  #@ Run backend linter (proxy)
  #@ Category: Backend
  backend lint
}

function typecheck {
  #@ Run backend type checker (proxy)
  #@ Category: Backend
  backend typecheck
}

################################################################################
# Frontend proxy

function frontend {
  #@ Proxy to frontend run script
  #@ Category: Frontend
  echo "âž¡ï¸  Running frontend command in ./frontend/run"
  cd frontend
  ./run "$@"
}

################################################################################
# Docker Management Commands

function build-devtools {
  #@ Build development Docker image
  #@ Category: Docker
  echo "ðŸ³ Building development Docker image..."
  docker compose -f docker/docker-compose.devtools.yml build devtools
  echo "âœ… Docker image built successfully"
}

function build-debtools {
  #@ Build Debian packaging Docker image
  #@ Category: Docker
  echo "ðŸ³ Building Debian packaging Docker image..."
  docker compose -f docker/docker-compose.debtools.yml build debtools
  echo "âœ… Docker image built successfully"
}

function clean-devtools {
  #@ Remove development Docker containers and images
  #@ Category: Docker
  echo "ðŸ§¹ Cleaning Docker containers and images..."
  docker compose -f docker/docker-compose.devtools.yml down --rmi all --volumes
  echo "âœ… Docker cleanup complete"
}

function clean-debtools {
  #@ Remove Debian packaging Docker containers and images
  #@ Category: Docker
  echo "ðŸ§¹ Cleaning Debian packaging Docker containers and images..."
  docker compose -f docker/docker-compose.debtools.yml down --rmi all --volumes
  echo "âœ… Docker cleanup complete"
}

################################################################################
# CI Commands

function ci-test {
  #@ Run all tests (backend + frontend) for CI
  #@ Category: CI
  echo "ðŸš€ Running all tests for CI..."
  test
  frontend test
  echo "âœ… All tests passed"
}

function ci-lint {
  #@ Run all linters (backend + frontend) for CI
  #@ Category: CI
  echo "ðŸš€ Running all linters for CI..."
  lint
  typecheck
  frontend lint
  frontend typecheck
  echo "âœ… All linters passed"
}

################################################################################
# Version Management Commands

function bumpversion {
  #@ Bump version using bumpversion tool (patch|minor|major)
  #@ Category: Version
  local BUMP_TYPE="${1:-}"

  if [[ -z "$BUMP_TYPE" ]]; then
    echo "Error: version bump type required"
    echo "Usage: ./run bumpversion [patch|minor|major]"
    exit 1
  fi

  if [[ ! "$BUMP_TYPE" =~ ^(patch|minor|major)$ ]]; then
    echo "Error: invalid bump type '$BUMP_TYPE'"
    echo "Usage: ./run bumpversion [patch|minor|major]"
    exit 1
  fi

  echo "ðŸ”¢ Bumping $BUMP_TYPE version..."

  # Check if bumpversion is installed
  if ! command -v bumpversion &> /dev/null; then
    echo "Error: bumpversion not installed"
    echo "Install with: pip install bump2version"
    exit 1
  fi

  # Run bumpversion
  bumpversion "$BUMP_TYPE"

  echo "âœ… Version bumped successfully"
  echo "ðŸ“ Remember to commit the version changes:"
  echo "   git add VERSION backend/pyproject.toml frontend/package.json"
  echo "   git commit -m \"chore: bump version to \$(cat VERSION)\""
}

################################################################################
# Utility Commands

function clean {
  #@ Clean build artifacts (proxy)
  #@ Category: Utility
  # Usage: ./run clean

  backend clean
  frontend clean
}

function hooks-install {
  #@ Install pre-commit hooks using lefthook
  #@ Category: Utility
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook install
  echo "âœ… Pre-commit hooks installed"
}

function hooks-run {
  #@ Run pre-commit hooks manually
  #@ Category: Utility
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook run pre-commit
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "Cockpit APT - Development Commands"
  echo "===================================="
  echo ""
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-25s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
  echo ""
  echo "Quick start (Backend):"
  echo "  1. ./run build-devtools    # Build development container"
  echo "  2. ./run backend test      # Run backend tests"
  echo "  3. ./run backend shell     # Open backend dev shell"
  echo ""
  echo "Quick start (Frontend):"
  echo "  1. cd frontend && npm install"
  echo "  2. ./run frontend build    # Build frontend"
  echo "  3. ./run frontend watch    # Watch for changes"
  echo ""
  echo "Development workflow:"
  echo "  ./run backend test         # Run backend tests after changes"
  echo "  ./run backend lint         # Check backend code style"
  echo "  ./run backend typecheck    # Check backend types"
  echo "  ./run backend format       # Format backend code"
  echo "  ./run [backend|frontend] clean  # Clean artifacts (default: both)"
}

################################################################################
# Commands end.

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
