#!/usr/bin/make -f

%:
	dh $@

override_dh_missing:
	# Ignore missing files - we install everything we need manually
	dh_missing --fail-missing 2>/dev/null || true

override_dh_auto_build:
	# Build frontend
	cd frontend && npm install && npm run build
	# Build backend (Python package with pyproject.toml)
	cd backend && pip3 install --target=$(CURDIR)/debian/tmp --upgrade .

override_dh_auto_install:
	# Rebuild backend if tmp was cleaned (happens between build and install phases)
	@if [ ! -d $(CURDIR)/debian/tmp/cockpit_apt_bridge ]; then \
		echo "Rebuilding backend for install phase..."; \
		cd backend && pip3 install --target=$(CURDIR)/debian/tmp --upgrade .; \
	fi
	# Install backend Python package
	mkdir -p $(CURDIR)/debian/cockpit-apt/usr/lib/python3/dist-packages
	cp -r $(CURDIR)/debian/tmp/cockpit_apt_bridge $(CURDIR)/debian/cockpit-apt/usr/lib/python3/dist-packages/
	cp -r $(CURDIR)/debian/tmp/cockpit_apt_bridge-*.dist-info $(CURDIR)/debian/cockpit-apt/usr/lib/python3/dist-packages/
	# Install CLI script
	mkdir -p $(CURDIR)/debian/cockpit-apt/usr/bin
	install -m 755 $(CURDIR)/debian/tmp/bin/cockpit-apt-bridge $(CURDIR)/debian/cockpit-apt/usr/bin/cockpit-apt-bridge
	# Install frontend
	mkdir -p $(CURDIR)/debian/cockpit-apt/usr/share/cockpit/apt
	cp -r frontend/dist/* $(CURDIR)/debian/cockpit-apt/usr/share/cockpit/apt/

override_dh_auto_clean:
	rm -rf frontend/node_modules frontend/dist
	rm -rf backend/build backend/*.egg-info
	rm -rf debian/tmp
